(self.webpackChunkwebsite_querystar_io=self.webpackChunkwebsite_querystar_io||[]).push([[846],{47:(e,t,a)=>{e.exports={src:{srcSet:a.p+"assets/ideal-img/result.6e8ef07.640.png 640w,"+a.p+"assets/ideal-img/result.befafdc.934.png 934w",images:[{path:a.p+"assets/ideal-img/result.6e8ef07.640.png",width:640,height:345},{path:a.p+"assets/ideal-img/result.befafdc.934.png",width:934,height:504}],src:a.p+"assets/ideal-img/result.6e8ef07.640.png",toString:function(){return a.p+"assets/ideal-img/result.6e8ef07.640.png"},placeholder:void 0,width:640,height:345},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAwklEQVQImSXDvU7CUBiA4TN5XbAg0QmGRhJcDCZObgwwsLmaeBcMXgADI6H8hAINC05iTgs64MBP7Xe+8hLDkzxmu/nFWkscRVh7GW3W/Hx+M33pMG+9E7baGOeU2K7xHhuUa3WqT01K98/clh8o5itc5+64KdQwICgJ4/CD3mDKaDKnPwwYjGf0g5CuPyNYfmFevQVv1QW77ZHTSchUEUlRdThx7PcJ/0zJ+HhXPvFqx1GEQyJoluFUSUVJJOMvdZwBUoCmRAbMceMAAAAASUVORK5CYII="}},3342:(e,t,a)=>{e.exports={src:{srcSet:a.p+"assets/ideal-img/title.f2b830f.640.png 640w,"+a.p+"assets/ideal-img/title.33a85ce.750.png 750w",images:[{path:a.p+"assets/ideal-img/title.f2b830f.640.png",width:640,height:428},{path:a.p+"assets/ideal-img/title.33a85ce.750.png",width:750,height:501}],src:a.p+"assets/ideal-img/title.f2b830f.640.png",toString:function(){return a.p+"assets/ideal-img/title.f2b830f.640.png"},placeholder:void 0,width:640,height:428},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAHCAYAAAAxrNxjAAAACXBIWXMAABCcAAAQnAEmzTo0AAABKklEQVQYlQEfAeD+AAQ8L6oCOy6qBjwxqw04N64TMT2xITFJtSotUbk1K1u9PCViwEgjbMQAAjsuqjFcVLZLaGq+UGNvwFZfdMNfXXzHal+Gy3Jdjc5sS4rNVR94yAAQPTiuO1VbuVNicsJXXHbEX1l8x1lIecZqUIfMck6Pz3tLldJpJYnPABg5RLMgOVG4NjhavEA2ZL9AKWTBSSVtxFkpesllKITNZiCM0W4ZkdMAMTtUvUVEXslaSl7GgWJu0joYZshBFWzQgUh+1ZNGftliSb/jbjap3QA+LFe/YCxfylE1csVkN3vMYSuDzWkmitF3J5HUfCOS1nw5pNtyKJzYAD8nZMBKJG3EUiF3x1wegMtmGofPbxeQ0nIVk9RxFZPTcRaS1HAWktQiIHpYjJuj+wAAAABJRU5ErkJggg=="}},7211:(e,t,a)=>{"use strict";a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var n=a(7462),s=(a(7294),a(4137)),o=a(5944);const i={},r="A Slack Bot That Extracts Topic Entities and Saves Them to a Google Sheet",l={unversionedId:"tutorials/unstructured-data-gsheet-bot/index",id:"tutorials/unstructured-data-gsheet-bot/index",title:"A Slack Bot That Extracts Topic Entities and Saves Them to a Google Sheet",description:"Objective",source:"@site/docs/tutorials/unstructured-data-gsheet-bot/index.mdx",sourceDirName:"tutorials/unstructured-data-gsheet-bot",slug:"/tutorials/unstructured-data-gsheet-bot/",permalink:"/docs/tutorials/unstructured-data-gsheet-bot/",draft:!1,tags:[],version:"current",lastUpdatedAt:1695064128,formattedLastUpdatedAt:"Sep 18, 2023",frontMatter:{},sidebar:"docs",previous:{title:"QueryStar \ud83c\udf1f + LlamaIndex \ud83e\udd99: Slack Bot that Understands Your Data",permalink:"/docs/tutorials/llamaindex-doc-bot/"},next:{title:"Triggers",permalink:"/docs/api/slack/triggers"}},p={},d=[{value:"Objective",id:"objective",level:2},{value:"About the Slack Bot",id:"about-the-slack-bot",level:2},{value:"The Use Case and Idea",id:"the-use-case-and-idea",level:3},{value:"Module Design",id:"module-design",level:3},{value:"Tech Stack",id:"tech-stack",level:3},{value:"The LLM Function",id:"the-llm-function",level:2},{value:"Prompt to <code>Llama-2-70b-chat-hf</code>",id:"prompt-to-llama-2-70b-chat-hf",level:3},{value:"Making LLM Function with Anyscale API",id:"making-llm-function-with-anyscale-api",level:3},{value:"Trigger-Action",id:"trigger-action",level:2},{value:"Prerequisite",id:"prerequisite",level:3},{value:"<code>slack.new_message()</code> Trigger",id:"slacknew_message-trigger",level:3},{value:"<code>google_sheet.add_message()</code> Action",id:"google_sheetadd_message-action",level:3},{value:"Result",id:"result",level:2}],c={toc:d},u="wrapper";function h(e){let{components:t,...i}=e;return(0,s.kt)(u,(0,n.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"a-slack-bot-that-extracts-topic-entities-and-saves-them-to-a-google-sheet"},"A Slack Bot That Extracts Topic Entities and Saves Them to a Google Sheet"),(0,s.kt)("h2",{id:"objective"},"Objective"),(0,s.kt)("p",null,"Learn how to build a Slack bot that automatically:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"extracts key topic entities")," using open source large language model ",(0,s.kt)("a",{parentName:"li",href:"https://huggingface.co/meta-llama/Llama-2-70b-hf"},"llama-2-70b-hf from Meta")," fine tuned by ",(0,s.kt)("a",{parentName:"li",href:"https://app.endpoints.anyscale.com/"},"Anyscale"),"."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"saves the entity data to a Google Sheet")," using QueryStar's ",(0,s.kt)("inlineCode",{parentName:"li"},"google_sheets.add_row()"),".")),(0,s.kt)(o.Z,{img:a(3342),style:{maxWidth:500,display:"block",margin:"0 auto"},mdxType:"Image"}),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},(0,s.kt)("strong",{parentName:"p"},"Usefulness:")," \u2b50\u2b50\u2b50\u2b50\u2b50 | ",(0,s.kt)("strong",{parentName:"p"},"Difficulty Level:")," \u2b50")),(0,s.kt)("admonition",{type:"note"},(0,s.kt)("p",{parentName:"admonition"},"Source code: ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/modelstar-labs/querystar-demo/tree/main/slack_gsheet_parser"},"https://github.com/modelstar-labs/querystar-demo/tree/main/slack_gsheet_parser"))),(0,s.kt)("h2",{id:"about-the-slack-bot"},"About the Slack Bot"),(0,s.kt)("h3",{id:"the-use-case-and-idea"},"The Use Case and Idea"),(0,s.kt)("p",null,"I am in a Slack channel where over a thousand senior technologists discuss different tech tools and stacks. All the questions and answers arise from their years of development experience. One example of such conversations:"),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"Q: We're on the hunt for some AI Code Assistant tools like Copilot, TabNine, Codeium, etc. Anybody out there got some hands-on experience with these? We're especially interested in telemetry and analytics, you know, to see how well these tools are doing and if they're making our coding lives better. Thx! \ud83d\ude80")),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"A: We've got \"xxxxxx\" in action, and I chatted up our engineers to get the lowdown. Here's the scoop:"),(0,s.kt)("ul",{parentName:"blockquote"},(0,s.kt)("li",{parentName:"ul"},"xx% of the crew keeps it fired up in their IDE 24/7."),(0,s.kt)("li",{parentName:"ul"},"About xx% use it daily."),(0,s.kt)("li",{parentName:"ul"},"The remaining xx% hit it up whenever they feel like it.")),(0,s.kt)("p",{parentName:"blockquote"},"As for how it performs, the consensus is that the code suggestions are usually solid when they hit the mark.")),(0,s.kt)("p",null,"It's valuable to analyze the conversations and save the results in an accessible place. An interesting perspective is to understand what popular tools and services often get their attention."),(0,s.kt)("p",null,"So we designed this bot, which can extract:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Tech products/services (e.g., ",(0,s.kt)("inlineCode",{parentName:"li"},"AWS EC2"),", ",(0,s.kt)("inlineCode",{parentName:"li"},"FastAPI"),") are discussed in a message, and"),(0,s.kt)("li",{parentName:"ul"},'The product category, e.g., "cloud service", "business intelligence", etc.')),(0,s.kt)("p",null,"Also, the bot should extract these entities on every message, and save the results to a Google Spreadsheet."),(0,s.kt)("h3",{id:"module-design"},"Module Design"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"AI (LLM) Function"))),(0,s.kt)("p",null,"After a new message is posted, this function should return:\n",(0,s.kt)("inlineCode",{parentName:"p"},'json\n    {\n        "product": ["<product1>", "<product2>"],\n        "category": "<product category>"\n    }\n    ')),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Trigger - Action"),":",(0,s.kt)("ul",{parentName:"li"},(0,s.kt)("li",{parentName:"ul"},"The bot should respond to messages that are sent to a designated channel"),(0,s.kt)("li",{parentName:"ul"},"The bot should extract ",(0,s.kt)("strong",{parentName:"li"},"Product Entities")," and their ",(0,s.kt)("strong",{parentName:"li"},"Category")," from the trigger"),(0,s.kt)("li",{parentName:"ul"},"The bot should save the results in a Google Sheet."),(0,s.kt)("li",{parentName:"ul"},"Wait for future trigger events.")))),(0,s.kt)("h3",{id:"tech-stack"},"Tech Stack"),(0,s.kt)("p",null,"We use ",(0,s.kt)("inlineCode",{parentName:"p"},"OpenAI")," to build the LLM function, and ",(0,s.kt)("inlineCode",{parentName:"p"},"Querystar")," for the bot. It only takes 3 API calls:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"OpenAI's ",(0,s.kt)("inlineCode",{parentName:"li"},"ChatCompletion")," API"),(0,s.kt)("li",{parentName:"ol"},"QueryStar's ",(0,s.kt)("inlineCode",{parentName:"li"},"triggers.slack.new_message()")),(0,s.kt)("li",{parentName:"ol"},"QueryStar's ",(0,s.kt)("inlineCode",{parentName:"li"},"actions.google_sheets.add_row()"))),(0,s.kt)("hr",null),(0,s.kt)("h2",{id:"the-llm-function"},"The LLM Function"),(0,s.kt)("h3",{id:"prompt-to-llama-2-70b-chat-hf"},"Prompt to ",(0,s.kt)("inlineCode",{parentName:"h3"},"Llama-2-70b-chat-hf")),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"Llama-2-70b-hf")," is developed by Meta and released to public recently. It contains 70 billion parameters. To optimize the model for chat, Anyscale made a fine-tuned version, called ",(0,s.kt)("inlineCode",{parentName:"p"},"Llama-2-70b-chat-hf"),". You can use this chat model from Anyscale's endpoint: ",(0,s.kt)("a",{parentName:"p",href:"https://app.endpoints.anyscale.com/"},"https://app.endpoints.anyscale.com/")),(0,s.kt)("admonition",{type:"note"},(0,s.kt)("p",{parentName:"admonition"},"The cost of using Anyscale-hosted ",(0,s.kt)("inlineCode",{parentName:"p"},"Llama-2-70b-chat-hf")," is $1 per 1 million tokens, which is 30% cheaper than that of ",(0,s.kt)("inlineCode",{parentName:"p"},"GPT-3.5-turbo"),", and 97% cheaper than ",(0,s.kt)("inlineCode",{parentName:"p"},"GPT-4")," from OpenAI. The price data are referenced as is on Sept. 18, 2023.")),(0,s.kt)("p",null,"The key capability of the function is to process a user message, and extract products and their category. This system prompt works quite well for this task."),(0,s.kt)("blockquote",null,(0,s.kt)("p",{parentName:"blockquote"},"You're a technologist. Your goal is to find what technical products are discussed in the user message, and what their category is. Output a dict:"),(0,s.kt)("p",{parentName:"blockquote"},'{"product": ','["product1", "product2"]',',\n"category": "product category"}'),(0,s.kt)("p",{parentName:"blockquote"},"If no product can be found, return an empty dict: {}")),(0,s.kt)("p",null,"Let's see how the prompt performs on the new Llama2 model."),(0,s.kt)("h3",{id:"making-llm-function-with-anyscale-api"},"Making LLM Function with Anyscale API"),(0,s.kt)("p",null,"Anyscale provides an endpoint to run Llama-2 query, let's define the function."),(0,s.kt)("p",null,"Fist, create a .py file called ",(0,s.kt)("inlineCode",{parentName:"p"},"app.py"),". We need Python's ",(0,s.kt)("inlineCode",{parentName:"p"},"requests")," libraryto call the endpoint, and necessary token and the API url."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},"import os, requests, json\n\ns = requests.Session()\n\nANYSCALE_TOKEN = os.getenv('ANYSCALE_TOKEN')    # add your own Anyscale token\nurl = \"https://api.endpoints.anyscale.com/v1/chat/completions\"\n\n")),(0,s.kt)("p",null,"For the function definition, we start off by building the prompt, then call the API endpoint to get Llama-2-70b-chat-hf's response. Llama2 is supposed to respond with a ",(0,s.kt)("inlineCode",{parentName:"p"},"JSON")," string, so we can parse the string with a simple parser. However, Llama sometimes adds extra characters in a response, which fails our ",(0,s.kt)("inlineCode",{parentName:"p"},"JSON")," parser. There are many tricks you can do to enforce JSON output format. But for the purpose of this tutorial, let's do a quick workaround: when the parser fails, we record the failure in ",(0,s.kt)("inlineCode",{parentName:"p"},"product['valid LLM answer']"),"and save it to the Google Sheet as well."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},'def extract_product(message: str) -> dict:\n    prompt = [\n        {\n            "role": "system",\n            "content": ("You\'re a technologist. "\n                        "Your goal is to find what technical products are discussed "\n                        "in the user message, and what their category is. "\n                        "Output a dict: \\n"\n                        "{\\"product\\": [\\"product1\\", \\"product2\\"],"\n                        "  \\"category\\": \\"product category\\"}\\n\\n"\n                        "If no product can be found, return an empty dict: {}")\n        },\n        {\n            "role": "user",\n            "content": message\n        },\n    ]\n    body = {\n        "model": "meta-llama/Llama-2-70b-chat-hf",\n        "messages": prompt,\n        "temperature": 0\n        }\n\n    with s.post(url, \n                headers={"Authorization": f"Bearer {ANYSCALE_TOKEN}"}, \n                json=body) as resp:\n        response = resp.json()\n\n    try:\n        product = json.loads(response[\'choices\'][0][\'message\'][\'content\'])\n        product[\'valid LLM answer\'] = True\n    except:\n        product = {\'valid LLM answer\': False}\n    \n    return product\n')),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"}," Now that the LLM function is ready, let's build the bot \ud83d\udcaa\ud83c\udffd\ud83e\udd16 ")),(0,s.kt)("h2",{id:"trigger-action"},"Trigger-Action"),(0,s.kt)("h3",{id:"prerequisite"},"Prerequisite"),(0,s.kt)("admonition",{type:"note"},(0,s.kt)("p",{parentName:"admonition"},"If this is your first time using QueryStar, follow these steps to set it up in less than 10 mins."),(0,s.kt)("details",null,(0,s.kt)("summary",null,"Set up QueryStar (click to expand)"),(0,s.kt)("p",null,(0,s.kt)("p",{parentName:"admonition"},"First off, let's ",(0,s.kt)("a",{parentName:"p",href:"../../quickstart/token"},"get a QueryStar token"),", ",(0,s.kt)("a",{parentName:"p",href:"../../quickstart/install"},"installed the library"),", and make sure you can ",(0,s.kt)("a",{parentName:"p",href:"../../quickstart/coding"},"run the ",(0,s.kt)("inlineCode",{parentName:"a"},"hello world")," Slack bot"),". The setup process should only ."),(0,s.kt)("p",{parentName:"admonition"},"Note:"),(0,s.kt)("ul",{parentName:"admonition"},(0,s.kt)("li",{parentName:"ul"},"QueryStar automatically integrate 3rd party API services which also include Slack authorization, so we do ",(0,s.kt)("strong",{parentName:"li"},"NOT")," need a Slack token here."),(0,s.kt)("li",{parentName:"ul"},"QueryStar token is free for one Slack workspace connection and unlimited bots in that workspace."))))),(0,s.kt)("h3",{id:"slacknew_message-trigger"},(0,s.kt)("inlineCode",{parentName:"h3"},"slack.new_message()")," Trigger"),(0,s.kt)("p",null,"This Slack message ",(0,s.kt)("inlineCode",{parentName:"p"},"trigger")," can be easily done with QueryStar's ",(0,s.kt)("inlineCode",{parentName:"p"},"triggers.slack.new_message()"),". Simply add these 2 lines to ",(0,s.kt)("inlineCode",{parentName:"p"},"app.py"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},"import querystar as qs\n\nmessage = qs.triggers.slack.new_message(channel_id='C***')\n")),(0,s.kt)("p",null,"This script is quite self-explanatory. The bot is set to listen to new Slack messages sent to a channel (denoted by the ",(0,s.kt)("inlineCode",{parentName:"p"},"channel_id"),"). When the trigger even happens, a ",(0,s.kt)("inlineCode",{parentName:"p"},"JSON")," object returns."),(0,s.kt)("details",null,(0,s.kt)("summary",null,"An example message object (click to expand)"),(0,s.kt)("p",null,(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n   "client_msg_id":"...",\n   "type":"message",\n   "text":"I\'ve been trying...",\n   "user":"useid...",\n   "ts":"1693582549.746649",\n   "blocks":[...],\n   "team":"...",\n   "thread_ts":"1693536314.270179",\n   "parent_user_id":"...",\n   "channel":"C05PRRJ0H4N",\n   "event_ts":"1693582549.746649",\n   "channel_type":"group"\n}\n')))),(0,s.kt)("h3",{id:"google_sheetadd_message-action"},(0,s.kt)("inlineCode",{parentName:"h3"},"google_sheet.add_message()")," Action"),(0,s.kt)("p",null,"Once a trigger event happens, the bot calls the LLM function and get extracted product entities and category. Then the bot adds the extracted data to a Google Sheet. The code:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},"product = extract_product(message['text'])\n\nqs.actions.google_sheets.add_row(\n    spreadsheet_id='add your spreadsheet_id here',\n    worksheet_id='Sheet1',\n    data=[[message['user'], message['text'], product['valid LLM answer'],\n           repr(product['product']), product['category'] ]]\n    )\n\n")),(0,s.kt)("p",null,"There are five columns in the entity table:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"User"),": Slack's ",(0,s.kt)("inlineCode",{parentName:"li"},"user_id")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"message"),": Slack message content"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"valid GPT answer"),": if the GPT response is a valid ",(0,s.kt)("inlineCode",{parentName:"li"},"JSON")," string"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"product name"),": a list of product names identified by GPT"),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("inlineCode",{parentName:"li"},"product category"),": product category identified by GPT")),(0,s.kt)("p",null,"We can add rows by sending this 2D array to Google Sheet via ",(0,s.kt)("inlineCode",{parentName:"p"},"google_sheets.add_row()")," API."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},"[\n  [\n    message['user'],\n    message['text'],\n    product['valid GPT answer'],\n    product['product'],\n    product['category']\n  ]\n]\n")),(0,s.kt)("p",null,"One thing requires attention here is that Google Sheet does not accept ",(0,s.kt)("inlineCode",{parentName:"p"},"list")," data type. We need to convert a list (",(0,s.kt)("inlineCode",{parentName:"p"},"product['product']"),") to a string using Python built-in ",(0,s.kt)("inlineCode",{parentName:"p"},"repr()")," function."),(0,s.kt)("h2",{id:"result"},"Result"),(0,s.kt)("p",null,"Open your terminal and run this command in the folder that contains your ",(0,s.kt)("inlineCode",{parentName:"p"},"app.py"),":"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"$ querystar run app.py\n")),(0,s.kt)("p",null,"Now, go to Slack and send the example message as shown in the section of ",(0,s.kt)("a",{parentName:"p",href:"#the-use-case-and-idea"},"The Use Case and Idea"),". In 1-2 seconds, a new row is added to the Google Sheet as shown below."),(0,s.kt)(o.Z,{img:a(47),style:{maxWidth:600,display:"block",margin:"0 auto"},mdxType:"Image"}))}h.isMDXComponent=!0}}]);